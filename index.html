<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Jornada PRO NAVANTIA Ferrol</title>

<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">  

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="styles.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script type="module" src="app.js"></script>
</head>

<body>

<header class="header">
  <h1 class="header-title">Jornada Pro NAVANTIA (Ferrol)</h1>
  <img src="icons/logo-navantia.png" alt="NAVANTIA" class="header-logo">
  <button type="button" id="btnMenuConfig" class="header-menu-btn" aria-label="Menú configuración">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>
</header>

<!-- Modal: ¿Extender jornada? -->
<div id="modalExtenderJornada" class="modal-extender" role="dialog" aria-labelledby="modalExtenderTitulo" aria-modal="true" hidden>
  <div class="modal-extender-backdrop"></div>
  <div class="modal-extender-box">
    <h3 id="modalExtenderTitulo" class="modal-extender-titulo">¿Vas a extender la jornada?</h3>
    <p class="modal-extender-texto">La jornada estipulada ha terminado. Si continúas, el tiempo se contará como horas extra hasta que finalices (botón o hora de salida real).</p>
    <div class="modal-extender-botones">
      <button type="button" id="modalExtenderNo" class="modal-extender-btn modal-extender-no">No</button>
      <button type="button" id="modalExtenderSi" class="modal-extender-btn modal-extender-si">Sí</button>
    </div>
  </div>
</div>

<!-- Modal: Pase de salida (antes de completar jornada) -->
<div id="modalPaseSalida" class="modal-extender" role="dialog" aria-labelledby="modalPaseSalidaTitulo" aria-modal="true" hidden>
  <div class="modal-extender-backdrop"></div>
  <div class="modal-extender-box">
    <h3 id="modalPaseSalidaTitulo" class="modal-extender-titulo">Pase de salida</h3>
    <p class="modal-extender-texto">Aún no has completado la jornada nominal. Indica el tipo de pase:</p>
    <div class="modal-extender-botones modal-pase-botones">
      <button type="button" id="modalPaseJustificado" class="modal-extender-btn modal-pase-justificado">Pase de salida justificado</button>
      <button type="button" id="modalPaseSinJustificar" class="modal-extender-btn modal-pase-sinjustificar">Pase de salida sin justificar</button>
    </div>
  </div>
</div>

<!-- Modal: Confirmar restaurar valores de fábrica -->
<div id="modalConfirmarFabrica" class="modal-extender" role="dialog" aria-labelledby="modalConfirmarFabricaTitulo" aria-modal="true" hidden>
  <div class="modal-extender-backdrop"></div>
  <div class="modal-extender-box">
    <h3 id="modalConfirmarFabricaTitulo" class="modal-extender-titulo">Restaurar valores de fábrica</h3>
    <p class="modal-extender-texto">Se borrarán todos los datos almacenados (registros, configuración, datos personales, banco de horas, etc.) y la aplicación volverá al estado inicial. Esta acción no se puede deshacer. ¿Confirmas?</p>
    <div class="modal-extender-botones">
      <button type="button" id="modalFabricaCancelar" class="modal-extender-btn modal-extender-no">Cancelar</button>
      <button type="button" id="modalFabricaSi" class="modal-extender-btn modal-extender-si">Sí, restaurar</button>
    </div>
  </div>
</div>

<!-- Modal: Confirmar eliminar registro del día -->
<div id="modalConfirmarEliminar" class="modal-extender" role="dialog" aria-labelledby="modalConfirmarEliminarTitulo" aria-modal="true" hidden>
  <div class="modal-extender-backdrop"></div>
  <div class="modal-extender-box">
    <h3 id="modalConfirmarEliminarTitulo" class="modal-extender-titulo">¿Eliminar registro del día?</h3>
    <p class="modal-extender-texto">Se borrarán todos los datos de este día. ¿Confirmas que deseas eliminarlos?</p>
    <div class="modal-extender-botones">
      <button type="button" id="modalEliminarCancelar" class="modal-extender-btn modal-extender-no">Cancelar</button>
      <button type="button" id="modalEliminarSi" class="modal-extender-btn modal-extender-si">Sí</button>
    </div>
  </div>
</div>

<!-- Panel configuración (desplegable desde el menú) -->
<div id="configPanel" class="config-panel">
  <div class="config-panel-inner">
    <h2 class="config-panel-title">Configuración</h2>

    <!-- 1. Datos Personales -->
    <details class="config-details">
      <summary class="config-summary">Datos Personales</summary>
      <div class="config-details-body">
        <div class="config-block">
          <label class="config-row">
            <span class="config-label">Nombre completo</span>
            <input type="text" id="cfgNombreCompleto" class="config-input config-input-full" placeholder="Nombre y apellidos">
          </label>
          <label class="config-row">
            <span class="config-label">Número SAP</span>
            <input type="text" id="cfgNumeroSAP" class="config-input" placeholder="8 cifras" maxlength="8" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
          </label>
          <p class="config-hint">Número SAP: 8 cifras.</p>
        </div>
      </div>
    </details>

    <!-- 2. Configuración Aplicación -->
    <details class="config-details">
      <summary class="config-summary">Configuración Aplicación</summary>
      <div class="config-details-body">
        <div class="config-block">
          <label class="config-row">
            <span class="config-label">Tema</span>
            <select id="cfgTheme" class="config-input config-select">
              <option value="light">Claro</option>
              <option value="dark">Oscuro</option>
            </select>
          </label>
          <label class="config-row config-toggle-row">
            <input type="checkbox" id="cfgNotificaciones" class="config-checkbox" checked>
            <span class="config-label">Notificaciones</span>
          </label>
          <label class="config-row">
            <span class="config-label">Aviso antes terminar (min)</span>
            <input type="number" id="cfgAviso" class="config-input" min="0">
          </label>
          <p class="config-hint">Aviso previo y fin de jornada solo cuando la app está abierta.</p>
        </div>
      </div>
    </details>

    <!-- 3. Configuración de Jornada -->
    <details class="config-details">
      <summary class="config-summary">Configuración de Jornada</summary>
      <div class="config-details-body">
        <div class="config-block config-block-turnos">
          <label class="config-row config-toggle-row">
            <input type="checkbox" id="cfgTrabajoTurnos" class="config-checkbox">
            <span class="config-label">Trabajo a turnos</span>
          </label>
          <div id="configTurnoWrap" class="config-turno-wrap" hidden>
            <label class="config-row">
              <span class="config-label">Turno</span>
              <select id="cfgTurno" class="config-input config-select">
                <option value="06-14">Mañana (06:00 – 14:00)</option>
                <option value="14-22">Tarde (14:00 – 22:00)</option>
                <option value="22-06">Noche (22:00 – 06:00)</option>
              </select>
            </label>
          </div>
        </div>
        <div class="config-block">
          <label class="config-row">
            <span class="config-label">Duración de la jornada (min)</span>
            <input type="number" id="cfgJornada" class="config-input" min="1">
          </label>
        </div>
        <div class="config-block config-iniciales">
          <span class="config-block-label">Saldo previo (antes de usar la app)</span>
          <label class="config-row">
            <span class="config-label">Horas extra previas (h)</span>
            <input type="number" id="cfgHorasExtraPrevias" class="config-input" min="0" step="0.25" placeholder="0">
          </label>
          <label class="config-row">
            <span class="config-label">Exceso jornada previo (h)</span>
            <input type="number" id="cfgExcesoJornadaPrevias" class="config-input" min="0" step="0.25" placeholder="0">
          </label>
          <label class="config-row">
            <span class="config-label" id="labelVacacionesDiasPrevio">Días de vacaciones previos (2025)</span>
            <input type="number" id="cfgVacacionesDiasPrevio" class="config-input" min="0" step="1" placeholder="0">
          </label>
          <p class="config-hint config-hint-vacaciones">Años anteriores a 2025 no se tienen en cuenta (ya venció su uso).</p>
          <div class="config-row config-row-reset">
            <button type="button" id="resetSaldoPrevio" class="config-btn config-btn-reset">Resetear saldo previo</button>
          </div>
          <p class="config-hint">Se suman al total disponible del banco (independiente del año).</p>
        </div>
      </div>
    </details>

    <div class="config-actions config-actions-guardar">
      <button type="button" id="guardarConfig" class="config-btn config-btn-primary">Guardar configuración</button>
    </div>

    <!-- 4. Copia de datos y seguridad -->
    <details class="config-details">
      <summary class="config-summary">Copia de datos y seguridad</summary>
      <div class="config-details-body">
        <div class="config-actions">
          <button type="button" id="excel" class="config-btn">Exportar Excel</button>
          <button type="button" id="backup" class="config-btn">Backup</button>
          <label class="config-btn config-btn-file">
            Restaurar
            <input type="file" id="restore" class="config-file-input">
          </label>
          <button type="button" id="restaurarFabrica" class="config-btn config-btn-reset">Restaurar valores de fábrica</button>
        </div>
      </div>
    </details>

    <div class="config-app-info">
      <span class="config-app-name">Jornada Pro</span> <span class="config-app-version">© 1.0</span>
      <div class="config-app-author"><span id="configAuthorTapTarget" class="config-author-tap">Autor</span>: Pablo Mouriz Fontao</div>
    </div>
    <div id="configDevMenu" class="config-dev-menu" hidden>
      <p class="config-dev-title">Desarrollador</p>
      <button type="button" id="btnResetDiaCurso" class="config-btn config-btn-reset">Resetear día en curso</button>
    </div>
  </div>
  <div id="configPanelBackdrop" class="config-panel-backdrop" aria-hidden="true"></div>
</div>

<!-- REGISTRO DIARIO -->
<section class="card registro">

  <!-- FORMULARIO REGISTRO -->
  <div class="form-card registro-card">

    <h3 style="margin-top:0;">Registro Diario</h3>

    <!-- BOTONES INICIAR / FINALIZAR JORNADA -->
    <div class="jornada-acciones">
      <button type="button" id="iniciarJornada" class="btn-jornada btn-iniciar">
        Iniciar jornada
      </button>
      <div id="finalizarJornadaWrap" class="finalizar-slider-wrap">
        <div id="finalizarSliderTrack" class="finalizar-slider-track">
          <span class="finalizar-slider-text">Desliza para finalizar jornada</span>
          <div id="finalizarSliderThumb" class="finalizar-slider-thumb" role="button" tabindex="0" aria-label="Deslizar para finalizar jornada"></div>
        </div>
      </div>
    </div>

    <!-- FECHA + ENTRADA -->
    <div class="grid-2">

      <div class="floating-group">
        <input type="date" id="fecha" required>
        <label for="fecha">Fecha</label>
      </div>

      <div class="floating-group">
        <input type="time" id="entrada" required>
        <label for="entrada">Hora de entrada</label>
      </div>

    </div>

    <!-- SALIDA + AJUSTE -->
    <div class="grid-2">

      <div class="floating-group">
        <input type="time" id="salida">
        <label for="salida">Hora de salida real</label>
      </div>

      <div class="floating-group">
        <input type="number" id="minAntes" min="0">
        <label for="minAntes">Salir antes (minutos)</label>
      </div>

    </div>

    <!-- DISFRUTADAS -->
    <div class="floating-group">
      <input type="number" id="disfrutadas" min="0">
      <label for="disfrutadas">Horas disfrutadas (min)</label>
    </div>

    <!-- BOTONES -->
    <div class="acciones-row">

      <button type="button" id="guardar">
        Guardar
      </button>

      <button type="button" id="vacaciones">
        Vacaciones
      </button>

      <button type="button" id="ld" class="btn-ld">
        LD
      </button>

      <button type="button" id="eliminar" class="btn-danger">
        Eliminar
      </button>

    </div>

  </div>

  <!-- SALIDAS VISUALES -->
  <div class="salidas-card">
    <div class="salida-box">
      <span class="salida-label">Salida teórica</span>
      <strong id="salidaTeorica">--:--</strong>
    </div>

    <div class="salida-box">
      <span class="salida-label">Salida ajustada</span>
      <strong id="salidaAjustada">--:--</strong>
    </div>
  </div>

  <!-- PROGRESO -->
  <div class="progress-wrapper">
  <div id="barra"></div>
  <div id="progresoInside" class="progress-text-inside"></div>
</div>

<div id="resumenDia" class="resumen-dia">
  <div class="resumen-line">
    <span>Trabajado</span>
    <strong id="rTrabajado">--</strong>
  </div>

  <div class="resumen-line">
    <span>Extra</span>
    <strong id="rExtra">--</strong>
  </div>

  <div class="resumen-line" id="resumenExcesoWrap">
    <span>Exceso jornada</span>
    <strong id="rExceso">--</strong>
  </div>

  <div class="resumen-line">
    <span>Negativa</span>
    <strong id="rNegativa">--</strong>
  </div>
</div>
  
</section>
  
<!-- GRID PRINCIPAL -->
<section class="main-grid">

  <!-- CALENDARIO -->
  <div class="card calendar-card">

    <div class="cal-nav">
      <button id="prevMes">◀</button>
      <span id="mesAnioLabel"></span>
      <button id="nextMes">▶</button>
    </div>

    <div id="calendarGrid" class="calendar-grid"></div>

  </div>

  <!-- GRÁFICO LATERAL -->
  <div class="card chart-card">
    <canvas id="chart"></canvas>
  </div>

</section>

<!-- MÉTRICAS BANCO (pestañas Horas TxT / Vacaciones) -->
<section class="card metrics">
  <div class="bank-tabs" role="tablist">
    <button type="button" id="bankTabHoras" class="bank-tab bank-tab--active" role="tab" aria-selected="true">Horas TxT</button>
    <button type="button" id="bankTabVacaciones" class="bank-tab" role="tab" aria-selected="false">Vacaciones/LD</button>
  </div>

  <!-- Pestaña Horas TxT -->
  <div id="bankPanelHoras" class="bank-panel bank-panel--active" role="tabpanel">
    <div class="metrics-header">
      <label class="metrics-year-label" for="selectBankYear">Año</label>
      <select id="selectBankYear" class="metrics-year-select" aria-label="Año del banco de horas"></select>
    </div>

    <div class="metric metric-total">
      <span>Total disponible (acumulado)</span>
      <strong id="bTotalDisponible"></strong>
    </div>

    <div class="metric">
      <span>Extra (Anual)</span>
      <strong id="bGeneradas"></strong>
    </div>

    <div class="metric">
      <span>Exceso jornada (Anual)</span>
      <strong id="bExceso"></strong>
    </div>

    <div class="metric">
      <span>Negativas (Anual)</span>
      <strong id="bNegativas"></strong>
    </div>

    <div class="metric">
      <span>Disfrutadas (Anual)</span>
      <strong id="bDisfrutadas"></strong>
    </div>

    <div class="metric saldo">
      <span>Saldo Anual</span>
      <strong id="bSaldoAnual"></strong>
    </div>

    <div class="metric saldo">
      <span>Saldo Mensual</span>
      <strong id="bSaldo"></strong>
    </div>
  </div>

  <!-- Pestaña Vacaciones/LD (dos columnas: vacaciones | LD) -->
  <div id="bankPanelVacaciones" class="bank-panel" role="tabpanel">
    <div class="bank-vacaciones-ld-wrap">
      <div class="bank-vacaciones-col">
        <div class="metric metric-total">
          <span>Total días de vacaciones disponibles</span>
          <strong id="bVacacionesTotal"></strong>
        </div>
        <div class="metric">
          <span>Año en curso (<span id="bVacacionesAnioCursoLabel"></span>)</span>
          <strong id="bVacacionesAnioCurso"></strong>
        </div>
        <div class="metric" id="wrapVacacionesAnioAnterior">
          <span>Días disponibles año <strong id="bVacacionesAnioAnteriorLabel" class="metric-year-inline"></strong></span>
          <strong id="bVacacionesAnioAnterior"></strong>
        </div>
        <p class="bank-vacaciones-leyenda" id="leyendaCaducidadVacaciones"></p>
      </div>
      <div class="bank-vacaciones-divider" aria-hidden="true"></div>
      <div class="bank-ld-col">
        <p class="bank-ld-titulo">Libre disposición</p>
        <div class="metric">
          <span>Año en curso (<span id="bLDAnioCursoLabel"></span>)</span>
          <strong id="bLDAnioCurso"></strong>
        </div>
        <p class="bank-vacaciones-leyenda" id="leyendaCaducidadLD">Los días LD caducan el 31 de diciembre del año en curso.</p>
      </div>
    </div>
  </div>

</section>

<!-- Modal: solicitar días LD del año en curso -->
<div id="modalLDAnio" class="modal-extender" role="dialog" aria-labelledby="modalLDAnioTitulo" aria-modal="true" hidden>
  <div class="modal-extender-backdrop"></div>
  <div class="modal-extender-box">
    <h3 id="modalLDAnioTitulo" class="modal-extender-titulo">Días de Libre Disposición</h3>
    <p class="modal-extender-texto">Indica el número de días de Libre Disposición para el año <strong id="modalLDAnioLabel"></strong>.</p>
    <label class="modal-ld-input-wrap">
      <span>Nº de días LD</span>
      <input type="number" id="inputLDAnio" class="config-input" min="0" step="1" value="0">
    </label>
    <div class="modal-extender-botones">
      <button type="button" id="modalLDAceptar" class="modal-extender-btn modal-extender-si">Aceptar</button>
    </div>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}
</script>  

</body>
</html>
